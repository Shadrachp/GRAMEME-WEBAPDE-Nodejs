/**
 * Copyright (c) 2016 - 2018 Sqreen. All Rights Reserved.
 * Please refer to our terms for more information: https://www.sqreen.io/terms.html
 */
'use strict';
const Shimmer = require('shimmer');
const NS = require('./ns').getNS();

module.exports = function (identity, mod) {

    const Client = mod.Client;

    Shimmer.wrap(Client.prototype, 'queryBuilder', (original) => {

        return function () {

            const res = original.apply(this, arguments);
            res.then = NS.bind(res.then);
            return res;
        };
    });

    Shimmer.wrap(Client.prototype, 'runner', (original) => {

        return function () {

            const runner = original.apply(this, arguments);

            if (NS.active) {
                let onRaise;
                if (NS.get('raise') === undefined) {
                    onRaise = [];
                    NS.set('raise', onRaise);
                }
                else {
                    onRaise = NS.get('raise');
                }
                onRaise.push(() => {

                    // knex does not prevent mutliple calls here.
                    runner.client.releaseConnection(runner.connection);
                });
            }

            return runner;
        };
    });
};
